name: numbat-tasks-development

services:
    api:
        build:
            dockerfile: docker/api/api.dockerfile
            context: .
        volumes:
            # Allow live reloading
            - ./api:/api
        env_file:
            - .env
        depends_on:
            database:
                condition: service_started
        # This is the equivalent of `docker run -it` and without it breakpoints don't work
        stdin_open: true
        tty: true
    database:
        image: postgres:16-bookworm
        volumes:
            - postgres_data:/var/lib/postgresql/data/
        env_file:
            - .env
    frontend:
        build:
            dockerfile: docker/frontend/frontend.dockerfile
            context: .
        volumes:
            - ./frontend:/frontend
            # By adding node_modules without source, we load everything in the `frontend`
            # directory except for the `node_modules` directory. So that we don't have to
            # have the packages installed on the docker host.
            - /frontend/node_modules/
        env_file:
            - .env
        environment:
            - PORT=8000
    docs:
        build:
            dockerfile: docker/docs/docs.dockerfile
            context: .
        volumes:
            - ./docs:/docs
        env_file:
            - .env
    caddy:
        image: caddy:2-alpine
        ports:
            - "0.0.0.0:8000:80"
        volumes:
            - ./docker/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
            - caddy_data:/data
            - caddy_config:/config
        depends_on:
            api:
                condition: service_started
            frontend:
                condition: service_started

volumes:
    postgres_data:
    caddy_data:
    caddy_config: